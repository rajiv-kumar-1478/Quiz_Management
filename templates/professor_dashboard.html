{% extends "base.html" %}
{% block content %}

<style>
  body {
    background: linear-gradient(to right, #667eea, #764ba2);
    color: #fff;
  }
  .quiz-card {
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    background-color: #ffffff;
    color: #000;
  }
  .accordion-button {
    font-weight: bold;
    font-size: 1.1rem;
  }
  .accordion-body {
    background-color: #f8f9fa;
    border-radius: 0 0 10px 10px;
  }
  .access-code-actions button {
    margin-left: 5px;
  }
  #quizSearch {
    margin-bottom: 20px;
    max-width: 100%;
    color: #000;
  }
  .accordion-item {
    transition: all 0.3s ease-in-out;
  }
  @media (max-width: 576px) {
    .accordion-button {
      font-size: 1rem;
    }
    canvas {
      max-width: 100% !important;
    }
  }
</style>

<h2 class="mb-4 text-white text-center">Your Quizzes</h2>
<div class="d-flex justify-content-center">
  <input type="text" id="quizSearch" class="form-control w-75 w-sm-100" placeholder="Search quiz...">
</div>

<div class="accordion mt-3" id="quizAccordion">
  {% for quiz in quizzes %}
  <div class="accordion-item quiz-card" data-title="{{ quiz.title | lower }}">
    <h2 class="accordion-header" id="heading{{ quiz.id }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ quiz.id }}" aria-expanded="false" aria-controls="collapse{{ quiz.id }}">
        {{ quiz.title }}
      </button>
    </h2>
    <div id="collapse{{ quiz.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ quiz.id }}" data-bs-parent="#quizAccordion">
      <div class="accordion-body">
        <p><strong>Created:</strong> {{ quiz.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% if quiz.access_code %}
        <div class="mb-2 access-code-actions">
          <strong>Access Code:</strong>
          <span id="access-code-{{ quiz.id }}">{{ quiz.access_code }}</span>
          <button class="btn btn-sm btn-outline-secondary" onclick="copyAccessCode({{ quiz.id }})">üìã Copy</button>
          <button class="btn btn-sm btn-outline-primary" onclick="editAccessCode({{ quiz.id }})">‚úèÔ∏è Edit</button>
        </div>
        {% endif %}
        <div class="mb-3 d-flex flex-column flex-md-row gap-2">
          <a href="{{ url_for('view_quiz_results', quiz_id=quiz.id) }}" class="btn btn-outline-warning btn-sm">View Full Results</a>
          <a href="{{ url_for('edit_quiz', quiz_id=quiz.id) }}" class="btn btn-outline-info btn-sm">Edit</a>
          <form action="{{ url_for('delete_quiz', quiz_id=quiz.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this quiz?')">
            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
          </form>
        </div>
        <div class="mt-2">
          <canvas id="chart{{ quiz.id }}" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function copyAccessCode(quizId) {
  const text = document.getElementById(`access-code-${quizId}`).innerText;
  navigator.clipboard.writeText(text).then(() => {
    alert("Access code copied!");
  });
}

function editAccessCode(quizId) {
  const currentSpan = document.getElementById(`access-code-${quizId}`);
  const oldCode = currentSpan.innerText;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = oldCode;
  input.classList.add('form-control', 'd-inline', 'w-auto');
  input.style.marginRight = '10px';
  input.id = `access-code-input-${quizId}`;
  const saveBtn = document.createElement('button');
  saveBtn.innerText = 'üíæ Save';
  saveBtn.className = 'btn btn-sm btn-success';
  saveBtn.onclick = function() {
    const newCode = input.value;
    fetch(`/professor/quiz/${quizId}/update_access_code`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ access_code: newCode })
    })
    .then(res => {
      if (res.ok) {
        currentSpan.innerText = newCode;
        currentSpan.style.display = 'inline';
        input.remove();
        saveBtn.remove();
      } else {
        alert('Failed to update.');
      }
    });
  };
  currentSpan.style.display = 'none';
  currentSpan.parentNode.insertBefore(input, currentSpan);
  currentSpan.parentNode.insertBefore(saveBtn, currentSpan);
}

document.addEventListener('DOMContentLoaded', function () {
  const analytics = {{ quiz_analytics | tojson }};
  analytics.forEach(item => {
    const canvas = document.getElementById('chart' + item.quiz_id);
    if (canvas) {
      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Attempts', 'Avg Score'],
          datasets: [{
            label: item.quiz_title,
            data: [item.attempts, item.avg_score],
            backgroundColor: ['#ff6384', '#36a2eb']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Analytics for ' + item.quiz_title }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }
  });
});

document.getElementById('quizSearch').addEventListener('input', function () {
  const searchValue = this.value.toLowerCase();
  document.querySelectorAll('.accordion-item').forEach(item => {
    const title = item.getAttribute('data-title');
    item.style.display = title.includes(searchValue) ? '' : 'none';
  });
});
</script>

{% endblock %}
