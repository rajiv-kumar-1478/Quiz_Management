{% extends "base.html" %}

{% block content %}
<h2 class="mb-4 text-center">{{ quiz.title }}</h2>

{% if remaining_seconds %}
<div class="sticky-top bg-white py-2 shadow-sm mb-3">
  <div class="container d-flex justify-content-between align-items-center">
    <div><strong>Question <span id="currentQuestionIndex">1</span> / {{ questions|length }}</strong></div>
    <div id="timer" class="text-primary fw-bold">‚è≥ Time Remaining: <span id="countdown"></span></div>
  </div>
</div>
{% endif %}
<!-- {% if remaining_seconds %}
<div class="sticky-top bg-white py-2 shadow-sm mb-3">
  <div class="container d-flex justify-content-between align-items-center">
    <div><strong>Question <span id="currentQuestionIndex">1</span> / {{ questions|length }}</strong></div>
    <div id="timer" class="text-primary fw-bold">‚è≥ Time Remaining: <span id="countdown"></span></div>
  </div>
</div>
{% endif %} -->

<!-- ‚úÖ INSERT INSTRUCTIONS HERE -->
<div class="mb-3">
  <div class="alert alert-secondary">
    <strong>Instructions:</strong>
    <ul class="mb-0">
      {% if quiz.time_limit %}
        <li>Time Limit: {{ quiz.time_limit }} minutes</li>
      {% endif %}
      <li>Marks per Correct Answer: {{ quiz.marks_correct }}</li>
      <li>Marks per Incorrect Answer: {{ quiz.marks_incorrect }}</li>
      <li>Unanswered questions will receive 0 marks.</li>
      <li>You may skip questions. You can attempt the quiz only once.</li>
    </ul>
  </div>
</div>
<!-- END INSTRUCTIONS -->

<div class="row">

  <div class="col-md-9">
    <form method="POST" action="{{ url_for('take_quiz', quiz_id=quiz.id) }}" id="quizForm">
      {% for question in questions %}
      <div class="question-card card mb-4 {% if not loop.first %}d-none{% endif %}" data-index="{{ loop.index }}" id="questionCard_{{ loop.index }}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Question {{ loop.index }}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger clear-btn" data-qid="{{ question.id }}">
            <i class="bi bi-x-circle"></i> Clear
          </button>
        </div>
        <div class="card-body">
          {% if question.text %}
            <p class="card-text">{{ question.text }}</p>
          {% endif %}
          {% if question.image %}
            <img src="{{ url_for('static', filename='uploads/' + question.image) }}" class="img-fluid mb-3" alt="Question Image">
          {% endif %}

          {% set saved = saved_answers[question.id|string] if saved_answers and question.id|string in saved_answers else None %}

          {% for opt in ['a', 'b', 'c', 'd'] %}
          <div class="form-check">
            <input class="form-check-input option-radio" type="radio"
                   name="q_{{ question.id }}"
                   id="q{{ question.id }}_{{ opt }}"
                   value="{{ opt }}"
                   {% if saved == opt %}checked{% endif %}>
            <label class="form-check-label" for="q{{ question.id }}_{{ opt }}">
              {{ opt|upper }}) {{ option_map[question.id][opt] }}
            </label>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}

      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" id="prevBtn">‚¨Ö Prev</button>
        <button type="button" class="btn btn-outline-secondary" id="nextBtn">Next ‚û°</button>
      </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary">Submit Quiz</button>
      </div>
    </form>
  </div>
  <div class="col-md-3">
    <h5 class="mb-3">üß≠ Navigation</h5>
    <div id="questionNav" class="d-grid gap-2">
      {% for question in questions %}
      <button type="button" class="btn btn-outline-secondary nav-btn" data-index="{{ loop.index }}" id="navBtn_{{ question.id }}">
        Q{{ loop.index }}
      </button>
      {% endfor %}
    </div>
  </div>
</div>

<style>
  .nav-btn.answered { background-color: #d1e7dd; border-color: #0f5132; color: #0f5132; }
  .nav-btn.current { border: 2px solid #0d6efd; }
</style>

{% endblock %}

{% block scripts %}
<script>
let totalSeconds = {{ remaining_seconds|default(0) }};
let currentIndex = 1;
const totalQuestions = {{ questions|length }};

function showQuestion(index) {
  document.querySelectorAll('.question-card').forEach(card => card.classList.add('d-none'));
  document.getElementById(`questionCard_${index}`).classList.remove('d-none');
  document.getElementById('currentQuestionIndex').textContent = index;

  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('current'));
  document.querySelector(`#questionNav .nav-btn[data-index="${index}"]`).classList.add('current');
}

function updateTimer() {
  const countdownEl = document.getElementById("countdown");
  const mins = Math.floor(totalSeconds / 60);
  const secs = totalSeconds % 60;
  countdownEl.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;

  if (totalSeconds <= 300) countdownEl.classList.add("warning");
  if (totalSeconds <= 0) document.getElementById("quizForm").submit();
  else {
    totalSeconds--;
    setTimeout(updateTimer, 1000);
  }
}
updateTimer();

// Navigation buttons
function goTo(index) {
  if (index >= 1 && index <= totalQuestions) {
    currentIndex = index;
    showQuestion(currentIndex);
  }
}

document.getElementById("prevBtn").addEventListener("click", () => goTo(currentIndex - 1));
document.getElementById("nextBtn").addEventListener("click", () => goTo(currentIndex + 1));
document.querySelectorAll(".nav-btn").forEach(btn => {
  btn.addEventListener("click", () => goTo(parseInt(btn.dataset.index)));
});

// Save answer on select or clear
function saveAnswer(qid, selected_option = null) {
  fetch("/save_answer", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token() if csrf_token is defined else '' }}"
    },
    body: JSON.stringify({ quiz_id: {{ quiz.id }}, question_id: qid, selected_option })
  });
}

document.querySelectorAll('.option-radio').forEach(input => {
  input.addEventListener("click", function () {
    const name = this.name;
    const qid = name.split("_")[1];

    if (this.dataset.waschecked === "true") {
      this.checked = false;
      this.dataset.waschecked = "false";
      saveAnswer(qid, null);
      return;
    }
    document.querySelectorAll(`input[name="${name}"]`).forEach(el => el.dataset.waschecked = "false");
    this.dataset.waschecked = "true";
    saveAnswer(qid, this.value);
    document.getElementById(`navBtn_${qid}`).classList.add("answered");
  });
});

document.querySelectorAll(".clear-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const qid = this.dataset.qid;
    document.querySelectorAll(`input[name="q_${qid}"]`).forEach(input => {
      input.checked = false;
      input.dataset.waschecked = "false";
    });
    saveAnswer(qid, null);
    document.getElementById(`navBtn_${qid}`).classList.remove("answered");
  });
});

// Auto poll for professor edits
let pollInterval = setInterval(() => {
    fetch(`/quiz/{{ quiz.id }}/check_update`).then(res => res.json()).then(data => {
        if (data.reload) {
            clearInterval(pollInterval);
            const changed = data.changed_questions?.join(', ') || 'some questions';
            const msg = `‚ö†Ô∏è Questions ${changed} were updated by the professor.\n\nDo you want to reload now to see changes?`;
            if (confirm(msg)) {
                fetch("/quiz/{{ quiz.id }}/mark_seen", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token() if csrf_token is defined else '' }}"
                    },
                    body: JSON.stringify({ questions_seen: data.changed_questions || [] })
                }).then(() => location.reload());
            }
        }
    }).catch(err => console.warn("Polling error:", err));
}, 60000);

// Prevent accidental leave
function handleBeforeUnload(e) {
  e.preventDefault();
  e.returnValue = "‚ö†Ô∏è You have an ongoing quiz. Leave this page?";
}
// window.addEventListener("beforeunload", handleBeforeUnload);
document.getElementById("quizForm").addEventListener("submit", () => {
  clearInterval(pollInterval);
  window.removeEventListener("beforeunload", handleBeforeUnload);
});
</script>
{% endblock %}
