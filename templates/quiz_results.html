{% extends "base.html" %}

{% block content %}
<h2>Result for: {{ quiz.title }}</h2>
<div class="alert alert-info">
    <h4 class="alert-heading">Your Score: {{ result.score }} out of {{ result.total_questions * result.quiz.marks_correct }}</h4>
    <p>Submitted on: {{ result.submitted_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
    <hr>
    <p class="mb-0">
        {% if result.score / result.total_questions >= 0.8 %}
            Excellent work!
        {% elif result.score / result.total_questions >= 0.6 %}
            Good job!
        {% else %}
            Keep practicing!
        {% endif %}
    </p>
</div>
<a href="{{ url_for('student_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
{% endblock %}



{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar Navigator -->
    <div class="col-md-2 bg-light vh-100 sticky-top pt-4 border-end" id="question-nav">
      <h6 class="text-center mb-3">üß≠ Navigate</h6>
      <div class="d-grid gap-2 px-2">
        {% for question in questions %}
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="navigateToQuestion({{ loop.index0 }})" id="nav-btn-{{ loop.index0 }}" aria-label="Go to question {{ loop.index }}">
          Q{{ loop.index }}
        </button>
        {% endfor %}
      </div>
    </div>

     <!-- Main Quiz Area -->
<div class="col-md-10 pt-3 px-4">
  <!-- Sticky Top Bar -->
  <div class="sticky-top bg-white py-2 border-bottom mb-3 d-flex justify-content-between align-items-center">
    <div><strong>Question <span id="question-number">1</span> of {{ questions|length }}</strong></div>
    {% if remaining_seconds %}
    <div class="text-danger fw-bold">‚è∞ Time Left: <span id="countdown"></span></div>
    {% endif %}
  </div>

  <!-- üü¢ INSERT INSTRUCTIONS HERE -->
  <div class="mb-3">
    <div class="alert alert-secondary">
      <strong>Instructions:</strong>
      <ul class="mb-0">
        {% if quiz.time_limit %}
          <li>Time Limit: {{ quiz.time_limit }} minutes</li>
        {% endif %}
        <li>Marks per Correct Answer: {{ quiz.marks_correct }}</li>
        <li>Marks per Incorrect Answer: {{ quiz.marks_incorrect }}</li>
        <li>Unanswered questions will receive 0 marks.</li>
        <li>You may skip questions. You can attempt the quiz only once.</li>
      </ul>
    </div>
  </div>
    <div class="col-md-10 pt-3 px-4">
      <!-- Sticky Top Bar -->
      <div class="sticky-top bg-white py-2 border-bottom mb-3 d-flex justify-content-between align-items-center">
        <div><strong>Question <span id="question-number">1</span> of {{ questions|length }}</strong></div>
        {% if remaining_seconds %}
        <div class="text-danger fw-bold">‚è∞ Time Left: <span id="countdown"></span></div>
        {% endif %}
      </div>

      <form method="POST" action="{{ url_for('take_quiz', quiz_id=quiz.id) }}" id="quiz-form">
        {% for question in questions %}
        <div class="question-block" style="{% if not loop.first %}display: none;{% endif %}">
          <div class="card mb-3">
            <div class="card-body">
              <h5>Q{{ loop.index }}. {{ question.text }}</h5>
              {% if question.image %}
              <img src="{{ url_for('static', filename='uploads/' + question.image) }}" class="img-fluid mb-3">
              {% endif %}
              {% set saved = saved_answers[(question.id|string)] if saved_answers and (question.id|string) in saved_answers else None %}
              {% for opt in ['a', 'b', 'c', 'd'] %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q_{{ question.id }}" id="q{{ question.id }}_{{ opt }}" value="{{ opt }}" {% if saved == opt %}checked{% endif %}>
                <label class="form-check-label" for="q{{ question.id }}_{{ opt }}">
                  {{ opt|upper }}) {{ option_map[question.id][opt] }}
                </label>
              </div>
              {% endfor %}
              <button type="button" class="btn btn-sm btn-outline-danger mt-3 clear-btn" data-qid="{{ question.id }}">
                Clear Answer
              </button>
            </div>
          </div>
        </div>
        {% endfor %}

        <div class="d-flex justify-content-between mt-4">
          <button type="button" class="btn btn-secondary" onclick="prevQuestion()">‚¨ÖÔ∏è Previous</button>
          <button type="button" class="btn btn-secondary" onclick="nextQuestion()">Next ‚û°Ô∏è</button>
          <button type="submit" class="btn btn-primary">Submit Quiz</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if remaining_seconds %}
<script>
let totalSeconds = {{ remaining_seconds|default(0) }};

function updateTimer() {
    const countdownEl = document.getElementById("countdown");
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;
    countdownEl.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    if (totalSeconds <= 300) {
        countdownEl.classList.add("warning");
    }
    if (totalSeconds <= 0) {
        clearInterval(pollInterval);
        document.getElementById("quiz-form").submit();
    } else {
        totalSeconds--;
        setTimeout(updateTimer, 1000);
    }
}
updateTimer();

let pollInterval = setInterval(() => {
    fetch(`/quiz/{{ quiz.id }}/check_update`).then(res => res.json()).then(data => {
        if (data.reload) {
            clearInterval(pollInterval);
            const changed = data.changed_questions?.join(', ') || 'some questions';
            const msg = `‚ö†Ô∏è Questions ${changed} were updated by the professor.\n\nDo you want to reload now to see changes?`;
            if (confirm(msg)) {
                fetch("/quiz/{{ quiz.id }}/mark_seen", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token() if csrf_token is defined else '' }}"
                    },
                    body: JSON.stringify({ questions_seen: data.changed_questions || [] })
                }).then(() => location.reload());
            }
        }
    }).catch(err => console.warn("Polling error:", err));
}, 60000);

function handleBeforeUnload(e) {
    if (performance.navigation.type === performance.navigation.TYPE_RELOAD) return;
    e.preventDefault();
    e.returnValue = "‚ö†Ô∏è You have an ongoing quiz. Are you sure you want to leave this page?";
}
window.addEventListener("beforeunload", handleBeforeUnload);
window.history.pushState(null, "", window.location.href);
window.addEventListener("popstate", function () {
    const confirmLeave = confirm("‚ö†Ô∏è Are you sure you want to leave the quiz? Your progress may be lost.");
    if (confirmLeave) {
        window.removeEventListener("beforeunload", handleBeforeUnload);
        history.back();
    } else {
        window.history.pushState(null, "", window.location.href);
    }
});

document.getElementById("quiz-form").addEventListener("submit", () => {
    clearInterval(pollInterval);
    window.removeEventListener("beforeunload", handleBeforeUnload);
});

document.querySelectorAll('input[type=radio]').forEach(input => {
    input.addEventListener('click', function () {
        const name = this.name;
        const questionId = name.split('_')[1];
        if (this.dataset.waschecked === "true") {
            this.checked = false;
            this.dataset.waschecked = "false";
            fetch("/save_answer", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token() if csrf_token is defined else '' }}"
                },
                body: JSON.stringify({ quiz_id: {{ quiz.id }}, question_id: questionId, selected_option: null })
            });
            return;
        }
        document.querySelectorAll(`input[name="${name}"]`).forEach(el => el.dataset.waschecked = "false");
        this.dataset.waschecked = "true";
        fetch("/save_answer", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() if csrf_token is defined else '' }}"
            },
            body: JSON.stringify({ quiz_id: {{ quiz.id }}, question_id: questionId, selected_option: this.value })
        });
    });
});

document.querySelectorAll(".clear-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const qid = this.dataset.qid;
        document.querySelectorAll(`input[name="q_${qid}"]`).forEach(input => {
            input.checked = false;
            input.dataset.waschecked = "false";
        });
        fetch("/save_answer", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() if csrf_token is defined else '' }}"
            },
            body: JSON.stringify({ quiz_id: {{ quiz.id }}, question_id: qid, selected_option: null })
        }).then(res => res.json()).then(data => {
            if (!data.success) {
                console.warn("Clear failed:", data.message);
            } else {
                console.log(`Cleared: Q${qid}`);
            }
        });
    });
});

let currentIndex = 0;
const totalQuestions = {{ questions|length }};

function showQuestion(index) {
  document.querySelectorAll('.question-block').forEach((el, i) => {
    el.style.display = (i === index) ? '' : 'none';
  });
  document.getElementById("question-number").innerText = index + 1;
  document.querySelectorAll('#question-nav button').forEach((btn, i) => {
    btn.classList.toggle('btn-primary', i === index);
    btn.classList.toggle('btn-outline-primary', i !== index);
  });
}

function nextQuestion() {
  if (currentIndex < totalQuestions - 1) {
    currentIndex++;
    showQuestion(currentIndex);
  }
}

function prevQuestion() {
  if (currentIndex > 0) {
    currentIndex--;
    showQuestion(currentIndex);
  }
}

function navigateToQuestion(index) {
  if (index !== currentIndex) {
    currentIndex = index;
    showQuestion(index);
  }
}

showQuestion(currentIndex);
</script>

<style>
#question-nav button.btn-primary {
  font-weight: bold;
  background-color: #0d6efd;
  color: white;
}
#question-nav {
  border-right: 1px solid #ccc;
  height: 100vh;
  overflow-y: auto;
}
.clear-btn:hover {
  transform: scale(1.05);
  transition: 0.2s ease-in-out;
}
#countdown {
  transition: color 0.5s ease;
}
#countdown.warning {
  color: red;
  font-weight: bold;
  animation: blink 1s step-start 0s infinite;
}
@keyframes blink {
  50% {
    opacity: 0;
  }
}
</style>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
{% endif %}
{% endblock %}
